import{_ as Q,r as V,o as d,c as k,a as u,w as r,F as U,l as O,e as v,b as R,g as N,t as X,d as q,f as E,s as $,E as B,h as L,i as Z,p as _,k as b,j as ee,u as le}from"./index-DpViZ-ad.js";import{u as te,c as ne,b as ae}from"./item-B8raeaaP.js";import{g as oe,a as ue,c as re,b as se}from"./meta-ywxASWoA.js";import{h as ie}from"./http-DCShZfjV.js";const me={class:"content-input"},de={key:1,class:"content-upload"},ce={class:"file-name"},pe={__name:"ItemFormFields",props:{form:{type:Object,required:!0},tags:{type:Array,default:()=>[]},plts:{type:Array,default:()=>[]},isFanficType:{type:Boolean,default:!1},contentInputMode:{type:String,default:"text"},contentFileName:{type:String,default:""},contentTypeOptions:{type:Array,default:()=>[]},mediaTypeOptions:{type:Array,default:()=>[]},trackingTypeOptions:{type:Array,default:()=>[]},endingTypeOptions:{type:Array,default:()=>[]},eraOptions:{type:Array,default:()=>[]},lengthTypeOptions:{type:Array,default:()=>[]},workTypeOptions:{type:Array,default:()=>[]},onContentFileChange:{type:Function,required:!0},clearContentFile:{type:Function,required:!0},onWheelField:{type:Function,required:!0},onWheelFanficField:{type:Function,required:!0}},emits:["update:contentInputMode"],setup(l,{emit:p}){const f=l,s=p,i=$({get:()=>f.contentInputMode,set:y=>s("update:contentInputMode",y)});return(y,a)=>{const n=V("el-option"),T=V("el-select"),c=V("el-form-item"),F=V("el-input"),M=V("el-radio-button"),W=V("el-radio-group"),A=V("el-button"),I=V("el-upload"),S=V("el-input-number"),D=V("el-date-picker");return d(),k(U,null,[u(c,{label:"媒体类型*"},{default:r(()=>[u(T,{modelValue:l.form.mediaType,"onUpdate:modelValue":a[0]||(a[0]=t=>l.form.mediaType=t),placeholder:"请选择媒体类型",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.mediaTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(c,{label:"内容类型*"},{default:r(()=>[u(T,{modelValue:l.form.contentType,"onUpdate:modelValue":a[1]||(a[1]=t=>l.form.contentType=t),placeholder:"请选择内容类型",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.contentTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(c,{label:"原作*"},{default:r(()=>[u(F,{modelValue:l.form.fandom,"onUpdate:modelValue":a[2]||(a[2]=t=>l.form.fandom=t)},null,8,["modelValue"])]),_:1}),u(c,{label:"CP*"},{default:r(()=>[u(F,{modelValue:l.form.cp,"onUpdate:modelValue":a[3]||(a[3]=t=>l.form.cp=t)},null,8,["modelValue"])]),_:1}),u(c,{label:"标题"},{default:r(()=>[u(F,{modelValue:l.form.title,"onUpdate:modelValue":a[4]||(a[4]=t=>l.form.title=t)},null,8,["modelValue"])]),_:1}),u(c,{label:"作者"},{default:r(()=>[u(F,{modelValue:l.form.author,"onUpdate:modelValue":a[5]||(a[5]=t=>l.form.author=t)},null,8,["modelValue"])]),_:1}),u(c,{label:"来源链接",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.sourceUrl,"onUpdate:modelValue":a[6]||(a[6]=t=>l.form.sourceUrl=t)},null,8,["modelValue"])]),_:1}),u(c,{label:"内容",class:"span-2"},{default:r(()=>[R("div",me,[u(W,{modelValue:i.value,"onUpdate:modelValue":a[7]||(a[7]=t=>i.value=t),size:"small"},{default:r(()=>[u(M,{label:"text"},{default:r(()=>[...a[26]||(a[26]=[N("直接输入",-1)])]),_:1}),u(M,{label:"file"},{default:r(()=>[...a[27]||(a[27]=[N("上传本地文件",-1)])]),_:1})]),_:1},8,["modelValue"]),i.value==="text"?(d(),v(F,{key:0,modelValue:l.form.content,"onUpdate:modelValue":a[8]||(a[8]=t=>l.form.content=t),type:"textarea",rows:"5",placeholder:"可直接粘贴/输入内容"},null,8,["modelValue"])):(d(),k("div",de,[u(I,{"auto-upload":!1,"show-file-list":!1,"on-change":l.onContentFileChange,limit:1,accept:".txt,.md,.json,.csv,.html,.htm,.xml,.yml,.yaml,image/*,video/*"},{default:r(()=>[u(A,null,{default:r(()=>[...a[28]||(a[28]=[N("选择本地文件",-1)])]),_:1})]),_:1},8,["on-change"]),R("span",ce,X(l.contentFileName||"未选择文件"),1),u(A,{text:"",onClick:l.clearContentFile},{default:r(()=>[...a[29]||(a[29]=[N("清空",-1)])]),_:1},8,["onClick"])]))])]),_:1}),u(c,{label:"年份"},{default:r(()=>[u(S,{modelValue:l.form.releaseYear,"onUpdate:modelValue":a[9]||(a[9]=t=>l.form.releaseYear=t),placeholder:"可滑动选取",min:2019,max:2030,onWheel:a[10]||(a[10]=q(t=>l.onWheelField("releaseYear",t,1,2019,2030),["prevent"]))},null,8,["modelValue"])]),_:1}),u(c,{label:"追踪状态"},{default:r(()=>[u(T,{modelValue:l.form.trackingType,"onUpdate:modelValue":a[11]||(a[11]=t=>l.form.trackingType=t),placeholder:"请选择追踪状态",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.trackingTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(c,{label:"评分(0-10)"},{default:r(()=>[u(S,{modelValue:l.form.rating,"onUpdate:modelValue":a[12]||(a[12]=t=>l.form.rating=t),placeholder:"可滑动选取",step:.5,min:0,max:10,onWheel:a[13]||(a[13]=q(t=>l.onWheelField("rating",t,.5,0,10),["prevent"]))},null,8,["modelValue"])]),_:1}),u(c,{label:"标签"},{default:r(()=>[u(T,{modelValue:l.form.tags,"onUpdate:modelValue":a[14]||(a[14]=t=>l.form.tags=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(d(!0),k(U,null,O(l.tags,t=>(d(),v(n,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(c,{label:"平台"},{default:r(()=>[u(T,{modelValue:l.form.plts,"onUpdate:modelValue":a[15]||(a[15]=t=>l.form.plts=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(d(!0),k(U,null,O(l.plts,t=>(d(),v(n,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(c,{label:"备注",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.notes,"onUpdate:modelValue":a[16]||(a[16]=t=>l.form.notes=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),u(c,{label:"总结",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.summary,"onUpdate:modelValue":a[17]||(a[17]=t=>l.form.summary=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),l.isFanficType?(d(),v(c,{key:0,label:"年代"},{default:r(()=>[u(T,{modelValue:l.form.fanficForm.era,"onUpdate:modelValue":a[18]||(a[18]=t=>l.form.fanficForm.era=t),placeholder:"请选择年代",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.eraOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:1,label:"篇幅"},{default:r(()=>[u(T,{modelValue:l.form.fanficForm.lengthType,"onUpdate:modelValue":a[19]||(a[19]=t=>l.form.fanficForm.lengthType=t),placeholder:"请选择篇幅",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.lengthTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:2,label:"作品状态"},{default:r(()=>[u(T,{modelValue:l.form.fanficForm.workType,"onUpdate:modelValue":a[20]||(a[20]=t=>l.form.fanficForm.workType=t),placeholder:"请选择作品状态",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.workTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:3,label:"结局"},{default:r(()=>[u(T,{modelValue:l.form.fanficForm.endingType,"onUpdate:modelValue":a[21]||(a[21]=t=>l.form.fanficForm.endingType=t),placeholder:"请选择结局",clearable:""},{default:r(()=>[(d(!0),k(U,null,O(l.endingTypeOptions,t=>(d(),v(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:4,label:"设定",class:"fanfic-setting"},{default:r(()=>[u(F,{modelValue:l.form.fanficForm.charSetting,"onUpdate:modelValue":a[22]||(a[22]=t=>l.form.fanficForm.charSetting=t)},null,8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:5,label:"上次更新日期"},{default:r(()=>[u(D,{modelValue:l.form.fanficForm.updateDate,"onUpdate:modelValue":a[23]||(a[23]=t=>l.form.fanficForm.updateDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"请选择日期",clearable:""},null,8,["modelValue"])]),_:1})):E("",!0),l.isFanficType?(d(),v(c,{key:6,label:"阅读次数"},{default:r(()=>[u(S,{modelValue:l.form.fanficForm.readCount,"onUpdate:modelValue":a[24]||(a[24]=t=>l.form.fanficForm.readCount=t),placeholder:"可滑动选取",min:0,onWheel:a[25]||(a[25]=q(t=>l.onWheelFanficField("readCount",t,1,0),["prevent"]))},null,8,["modelValue"])]),_:1})):E("",!0)],64)}}},fe=Q(pe,[["__scopeId","data-v-470cefbe"]]),ye=l=>ie.post("/api/oss/presign",l),be=[{value:1,label:"文章"},{value:2,label:"图绘"},{value:3,label:"精修"},{value:4,label:"混剪"},{value:5,label:"解析"},{value:6,label:"吐槽"},{value:7,label:"主创说"},{value:8,label:"RPS"},{value:9,label:"其他"}],ge=[{value:1,label:"文本"},{value:2,label:"静图"},{value:3,label:"动图"},{value:4,label:"实况照片"},{value:5,label:"视频"},{value:6,label:"链接"}],ve=[{value:1,label:"未看"},{value:2,label:"在看"},{value:3,label:"追平"},{value:4,label:"看过"},{value:5,label:"归档"}],Te=[{value:1,label:"HE"},{value:2,label:"BE"},{value:3,label:"OE"},{value:4,label:"ME"}],Fe=[{value:1,label:"古代"},{value:2,label:"民国"},{value:3,label:"现代"}],Ve=[{value:1,label:"短篇"},{value:2,label:"中篇"},{value:3,label:"长篇"}],ke=[{value:1,label:"已完结"},{value:2,label:"更新中"},{value:3,label:"断更"},{value:4,label:"已弃"}],we=()=>({era:null,charSetting:"",lengthType:null,workType:null,updateDate:null,endingType:null,readCount:1}),Ue=(l,p)=>new Promise((f,s)=>{const i=new FileReader;i.onload=()=>f(i.result||""),i.onerror=s,p?i.readAsText(l):i.readAsDataURL(l)}),he=l=>{var f;const p=/\.(txt|md|json|csv|html?|xml|ya?ml|js|ts|vue|java|kt|py|go|rs|sql|sh)$/i;return((f=l.type)==null?void 0:f.startsWith("text/"))||p.test(l.name||"")},Oe=(l,p,f)=>{let s=l;return typeof p=="number"&&(s=Math.max(p,s)),typeof f=="number"&&(s=Math.min(f,s)),s},Y=80,xe=180,G=(l,p,f)=>{const s=Date.now(),i=l.get(p)||{acc:0,lastAt:0};s-i.lastAt>xe&&(i.acc=0),i.lastAt=s,i.acc+=-f.deltaY;let y=0;return i.acc>=Y?y=Math.floor(i.acc/Y):i.acc<=-Y&&(y=Math.ceil(i.acc/Y)),y!==0&&(i.acc-=y*Y),l.set(p,i),y},J=(l,p,f,s,i)=>{if(p===0)return l;const y=typeof l=="number"?l:typeof s=="number"?s:0,a=p*f,n=Number((y+a).toFixed(6));return Oe(n,s,i)},h=l=>{if(l==null)return null;const p=String(l).trim();return p===""?null:p},K=l=>[2,3,4,5].includes(Number(l)),Ce=async(l,p)=>{const f=(l==null?void 0:l.type)||"application/octet-stream",s=await ye({file_name:(l==null?void 0:l.name)||"file.bin",content_type:f,size:(l==null?void 0:l.size)||0,media_type:p}),i=(s==null?void 0:s.uploadUrl)??(s==null?void 0:s.upload_url),y=(s==null?void 0:s.fileUrl)??(s==null?void 0:s.file_url);if(!i||!y)throw new Error("签名返回值不完整");return await fetch(i,{method:"PUT",headers:{"Content-Type":f},body:l}).then(async a=>{if(!a.ok){const n=await a.text().catch(()=>"");throw new Error(n||`OSS 上传失败(${a.status})`)}}),y},Ae=({route:l,router:p})=>{const f=L([]),s=L([]),i=L("text"),y=L(""),a=new Map,n=Z({mediaType:null,contentType:null,storeUrl:"",content:null,title:"",fandom:"风声",cp:"玉梦",author:"",sourceUrl:"",releaseYear:null,trackingType:null,rating:null,notes:"",summary:"",fanficForm:we(),tags:[],plts:[]}),T=$(()=>!!l.params.id),c=$(()=>Number(n.contentType)===1),F=async e=>{const o=e==null?void 0:e.raw;if(o)try{if(K(n.mediaType)){const g=await Ce(o,n.mediaType);n.storeUrl=g,n.content=g,y.value=o.name||"",B.success("文件已上传到 OSS");return}const m=he(o);n.content=await Ue(o,m),y.value=o.name||""}catch(m){B.error((m==null?void 0:m.message)||"上传失败，请稍后重试")}},M=()=>{y.value="",n.content=null,n.storeUrl=null},W=async()=>{if(!T.value)return;const e=await ae(l.params.id),o=(e==null?void 0:e.fanficForm)||(e==null?void 0:e.fanfic_form)||{};n.mediaType=(e==null?void 0:e.mediaType)??(e==null?void 0:e.media_type)??null,n.contentType=(e==null?void 0:e.contentType)??(e==null?void 0:e.content_type)??null,n.storeUrl=(e==null?void 0:e.storeUrl)??(e==null?void 0:e.store_url)??null,n.content=(e==null?void 0:e.content)??null,n.title=(e==null?void 0:e.title)??null,n.fandom=(e==null?void 0:e.fandom)??"风声",n.cp=(e==null?void 0:e.cp)??"玉梦",n.author=(e==null?void 0:e.author)??null,n.sourceUrl=(e==null?void 0:e.sourceUrl)??(e==null?void 0:e.source_url)??null,n.releaseYear=(e==null?void 0:e.releaseYear)??(e==null?void 0:e.release_year)??null,n.trackingType=(e==null?void 0:e.trackingType)??(e==null?void 0:e.tracking_type)??null,n.rating=(e==null?void 0:e.rating)??null,n.notes=(e==null?void 0:e.notes)??null,n.summary=(e==null?void 0:e.summary)??null,n.fanficForm={era:(o==null?void 0:o.era)??null,charSetting:(o==null?void 0:o.charSetting)??(o==null?void 0:o.char_setting)??null,lengthType:(o==null?void 0:o.lengthType)??(o==null?void 0:o.length_type)??null,workType:(o==null?void 0:o.workType)??(o==null?void 0:o.work_type)??null,updateDate:(o==null?void 0:o.updateDate)??(o==null?void 0:o.update_date)??null,endingType:(o==null?void 0:o.endingType)??(o==null?void 0:o.ending_type)??null,readCount:(o==null?void 0:o.readCount)??(o==null?void 0:o.read_count)??null},n.tags=((e==null?void 0:e.tags)||(e==null?void 0:e.tag_vos)||[]).map(m=>(m==null?void 0:m.name)||(m==null?void 0:m.tag_name)||m).filter(Boolean),n.plts=((e==null?void 0:e.plts)||(e==null?void 0:e.plt_vos)||[]).map(m=>(m==null?void 0:m.name)||(m==null?void 0:m.plt_name)||m).filter(Boolean),i.value=typeof n.content=="string"&&n.content.startsWith("data:")?"file":"text",y.value=""},A=async()=>{const[e,o]=await Promise.all([oe(),ue()]);f.value=Array.isArray(e)?e:[],s.value=Array.isArray(o)?o:[]},I=async(e,o,m)=>{const g=[...new Set((e||[]).map(w=>String(w||"").trim()).filter(Boolean))],x=new Set((o.value||[]).map(w=>w==null?void 0:w.name).filter(Boolean)),C=g.filter(w=>!x.has(w));C.length!==0&&await Promise.all(C.map(w=>m({name:w})))},S=(e,o,m=1,g,x)=>{const C=G(a,`form:${e}`,o);n[e]=J(n[e],C,m,g,x)},D=(e,o,m=1,g,x)=>{const C=G(a,`fanfic:${e}`,o);n.fanficForm[e]=J(n.fanficForm[e],C,m,g,x)},t=()=>({media_type:n.mediaType,content_type:n.contentType,store_url:K(n.mediaType)?h(n.storeUrl??n.content):null,content:Number(n.mediaType)===1?h(n.content):null,title:h(n.title),fandom:h(n.fandom)??"风声",cp:h(n.cp)??"玉梦",author:h(n.author),source_url:h(n.sourceUrl),release_year:n.releaseYear,tracking_type:n.trackingType,rating:n.rating,notes:h(n.notes),summary:h(n.summary),fanfic_form:c.value?{era:n.fanficForm.era,char_setting:h(n.fanficForm.charSetting),length_type:n.fanficForm.lengthType,work_type:n.fanficForm.workType,update_date:n.fanficForm.updateDate,ending_type:n.fanficForm.endingType,read_count:n.fanficForm.readCount??1}:null,media_form:Number(n.mediaType)===4?{live_url:null}:null,tags:[...new Set((n.tags||[]).map(e=>String(e||"").trim()).filter(Boolean))],plts:[...new Set((n.plts||[]).map(e=>String(e||"").trim()).filter(Boolean))]}),P=()=>{const e=Number(n.contentType);return e===1?{path:"/fanfic"}:e>1?{path:"/items",query:{contentType:e}}:{path:"/items"}};return{form:n,isEdit:T,isFanficType:c,tags:f,plts:s,contentInputMode:i,contentFileName:y,contentTypeOptions:be,mediaTypeOptions:ge,trackingTypeOptions:ve,endingTypeOptions:Te,eraOptions:Fe,lengthTypeOptions:Ve,workTypeOptions:ke,onContentFileChange:F,clearContentFile:M,onWheelField:S,onWheelFanficField:D,submit:async()=>{if(!n.mediaType||!n.contentType||!n.fandom||!n.cp)return B.warning("请先填写必填项");await I(n.tags,f,re),await I(n.plts,s,se),await A();const e=t();T.value?(await te(l.params.id,e),B.success("更新成功")):(await ne(e),B.success("创建成功")),p.push(P())},init:async()=>{await A(),await W()}}},Se={class:"card-panel panel"},Ee={__name:"ItemFormView",setup(l){const p=ee(),f=le(),{form:s,isEdit:i,isFanficType:y,tags:a,plts:n,contentInputMode:T,contentFileName:c,contentTypeOptions:F,mediaTypeOptions:M,trackingTypeOptions:W,endingTypeOptions:A,eraOptions:I,lengthTypeOptions:S,workTypeOptions:D,onContentFileChange:t,clearContentFile:P,onWheelField:j,onWheelFanficField:H,submit:e,init:o}=Ae({route:p,router:f});return _(o),(m,g)=>{const x=V("el-button"),C=V("el-form-item"),w=V("el-form");return d(),k("section",Se,[R("h2",null,X(b(i)?"编辑作品":"新增作品"),1),u(w,{model:b(s),"label-position":"top",size:"small",class:"form-grid compact-form"},{default:r(()=>[u(fe,{form:b(s),tags:b(a),plts:b(n),"is-fanfic-type":b(y),"content-input-mode":b(T),"content-file-name":b(c),"content-type-options":b(F),"media-type-options":b(M),"tracking-type-options":b(W),"ending-type-options":b(A),"era-options":b(I),"length-type-options":b(S),"work-type-options":b(D),"on-content-file-change":b(t),"clear-content-file":b(P),"on-wheel-field":b(j),"on-wheel-fanfic-field":b(H),"onUpdate:contentInputMode":g[0]||(g[0]=z=>T.value=z)},null,8,["form","tags","plts","is-fanfic-type","content-input-mode","content-file-name","content-type-options","media-type-options","tracking-type-options","ending-type-options","era-options","length-type-options","work-type-options","on-content-file-change","clear-content-file","on-wheel-field","on-wheel-fanfic-field"]),u(C,{class:"span-2"},{default:r(()=>[u(x,{type:"primary",onClick:b(e)},{default:r(()=>[...g[2]||(g[2]=[N("保存",-1)])]),_:1},8,["onClick"]),u(x,{onClick:g[1]||(g[1]=z=>m.$router.back())},{default:r(()=>[...g[3]||(g[3]=[N("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])}}},De=Q(Ee,[["__scopeId","data-v-87f57a13"]]);export{De as default};

import{_ as pe,p as de,c as i,b as B,t as P,a as n,w as r,s as h,r as c,h as U,j as ie,i as ce,u as fe,o as m,F as b,l as v,g as _,e as f,d as N,f as V,E as x}from"./index-BGlc7I5O.js";import{b as ye,u as be,c as ve}from"./item-Db9f4T6R.js";import{g as ge,a as Ve,c as _e,b as Te}from"./meta-Dh4DDZFz.js";import"./http-Cn4L8HpG.js";const ke={class:"card-panel panel"},we={class:"content-input"},Fe={key:1,class:"content-upload"},Ue={class:"file-name"},T=80,xe=180,Se={__name:"ItemFormView",setup(Ee){const S=ie(),j=fe(),E=U([]),A=U([]),k=U("text"),w=U(""),H=[{value:1,label:"文章"},{value:2,label:"图绘"},{value:3,label:"精修"},{value:4,label:"混剪"},{value:5,label:"解析"},{value:6,label:"吐槽"},{value:7,label:"主创说"},{value:8,label:"RPS"},{value:9,label:"其他"}],$=[{value:1,label:"文本"},{value:2,label:"静图"},{value:3,label:"动图"},{value:4,label:"实况照片"},{value:5,label:"视频"},{value:6,label:"链接"}],q=[{value:1,label:"未看"},{value:2,label:"在看"},{value:3,label:"追平"},{value:4,label:"看过"},{value:5,label:"归档"}],z=[{value:1,label:"HE"},{value:2,label:"BE"},{value:3,label:"OE"},{value:4,label:"ME"}],G=[{value:1,label:"古代"},{value:2,label:"民国"},{value:3,label:"现代"}],J=[{value:1,label:"短篇"},{value:2,label:"中篇"},{value:3,label:"长篇"}],K=[{value:1,label:"已完结"},{value:2,label:"更新中"},{value:3,label:"断更"},{value:4,label:"已弃"}],a=ce({mediaType:null,contentType:null,content:null,title:"",fandom:"风声",cp:"玉梦",author:"",sourceUrl:"",releaseYear:null,trackingType:null,rating:null,notes:"",summary:"",fanficForm:{era:null,charSetting:"",lengthType:null,workType:null,updateDate:null,endingType:null,readCount:1},tags:[],plts:[]}),D=h(()=>!!S.params.id),g=h(()=>Number(a.contentType)===1),Q=(l,e)=>new Promise((o,s)=>{const u=new FileReader;u.onload=()=>o(u.result||""),u.onerror=s,e?u.readAsText(l):u.readAsDataURL(l)}),X=l=>{var o;const e=/\.(txt|md|json|csv|html?|xml|ya?ml|js|ts|vue|java|kt|py|go|rs|sql|sh)$/i;return((o=l.type)==null?void 0:o.startsWith("text/"))||e.test(l.name||"")},Z=async l=>{const e=l==null?void 0:l.raw;if(!e)return;const o=X(e);a.content=await Q(e,o),w.value=e.name||"",o||x.info("已读取为 Base64 Data URL")},ee=()=>{w.value="",a.content=null},le=async()=>{if(!D.value)return;const l=await ye(S.params.id),e=(l==null?void 0:l.fanficForm)||(l==null?void 0:l.fanfic_form)||{};a.mediaType=(l==null?void 0:l.mediaType)??(l==null?void 0:l.media_type)??null,a.contentType=(l==null?void 0:l.contentType)??(l==null?void 0:l.content_type)??null,a.content=(l==null?void 0:l.content)??null,a.title=(l==null?void 0:l.title)??"",a.fandom=(l==null?void 0:l.fandom)??"风声",a.cp=(l==null?void 0:l.cp)??"玉梦",a.author=(l==null?void 0:l.author)??"",a.sourceUrl=(l==null?void 0:l.sourceUrl)??(l==null?void 0:l.source_url)??"",a.releaseYear=(l==null?void 0:l.releaseYear)??(l==null?void 0:l.release_year)??null,a.trackingType=(l==null?void 0:l.trackingType)??(l==null?void 0:l.tracking_type)??null,a.rating=(l==null?void 0:l.rating)??null,a.notes=(l==null?void 0:l.notes)??"",a.summary=(l==null?void 0:l.summary)??"",a.fanficForm={era:(e==null?void 0:e.era)??null,charSetting:(e==null?void 0:e.charSetting)??(e==null?void 0:e.char_setting)??"",lengthType:(e==null?void 0:e.lengthType)??(e==null?void 0:e.length_type)??null,workType:(e==null?void 0:e.workType)??(e==null?void 0:e.work_type)??null,updateDate:(e==null?void 0:e.updateDate)??(e==null?void 0:e.update_date)??null,endingType:(e==null?void 0:e.endingType)??(e==null?void 0:e.ending_type)??null,readCount:(e==null?void 0:e.readCount)??(e==null?void 0:e.read_count)??1},a.tags=((l==null?void 0:l.tags)||(l==null?void 0:l.tag_vos)||[]).map(o=>(o==null?void 0:o.name)||(o==null?void 0:o.tag_name)||o).filter(Boolean),a.plts=((l==null?void 0:l.plts)||(l==null?void 0:l.plt_vos)||[]).map(o=>(o==null?void 0:o.name)||(o==null?void 0:o.plt_name)||o).filter(Boolean),k.value=typeof a.content=="string"&&a.content.startsWith("data:")?"file":"text",w.value=""},Y=async()=>{const[l,e]=await Promise.all([ge(),Ve()]);E.value=Array.isArray(l)?l:[],A.value=Array.isArray(e)?e:[]},L=async(l,e,o)=>{const s=[...new Set((l||[]).map(d=>String(d||"").trim()).filter(Boolean))],u=new Set((e.value||[]).map(d=>d==null?void 0:d.name).filter(Boolean)),p=s.filter(d=>!u.has(d));p.length!==0&&await Promise.all(p.map(d=>o({name:d})))},ae=(l,e,o)=>{let s=l;return typeof e=="number"&&(s=Math.max(e,s)),typeof o=="number"&&(s=Math.min(o,s)),s},W=new Map,O=(l,e)=>{const o=Date.now(),s=W.get(l)||{acc:0,lastAt:0};o-s.lastAt>xe&&(s.acc=0),s.lastAt=o,s.acc+=-e.deltaY;let u=0;return s.acc>=T?u=Math.floor(s.acc/T):s.acc<=-T&&(u=Math.ceil(s.acc/T)),u!==0&&(s.acc-=u*T),W.set(l,s),u},R=(l,e,o,s,u)=>{if(e===0)return l;const p=typeof l=="number"?l:typeof s=="number"?s:0,d=e*o,C=Number((p+d).toFixed(6));return ae(C,s,u)},I=(l,e,o=1,s,u)=>{const p=O(`form:${l}`,e);a[l]=R(a[l],p,o,s,u)},te=(l,e,o=1,s,u)=>{const p=O(`fanfic:${l}`,e);a.fanficForm[l]=R(a.fanficForm[l],p,o,s,u)},y=l=>{if(l==null)return null;const e=String(l).trim();return e===""?null:e},ne=()=>({media_type:a.mediaType,content_type:a.contentType,content:y(a.content),title:y(a.title),fandom:y(a.fandom)??"风声",cp:y(a.cp)??"玉梦",author:y(a.author),source_url:y(a.sourceUrl),release_year:a.releaseYear,tracking_type:a.trackingType,rating:a.rating,notes:y(a.notes),summary:y(a.summary),fanfic_form:g.value?{era:a.fanficForm.era,char_setting:y(a.fanficForm.charSetting),length_type:a.fanficForm.lengthType,work_type:a.fanficForm.workType,update_date:a.fanficForm.updateDate,ending_type:a.fanficForm.endingType,read_count:a.fanficForm.readCount??1}:null,tags:[...new Set((a.tags||[]).map(l=>String(l||"").trim()).filter(Boolean))],plts:[...new Set((a.plts||[]).map(l=>String(l||"").trim()).filter(Boolean))]}),oe=()=>{const l=Number(a.contentType);return l===1?{path:"/fanfic"}:l>1?{path:"/items",query:{contentType:l}}:{path:"/items"}},ue=async()=>{if(!a.mediaType||!a.contentType||!a.fandom||!a.cp)return x.warning("请先填写必填项");await L(a.tags,E,_e),await L(a.plts,A,Te),await Y();const l=ne();D.value?(await be(S.params.id,l),x.success("更新成功")):(await ve(l),x.success("创建成功")),j.push(oe())};return de(async()=>{await Y(),await le()}),(l,e)=>{const o=c("el-option"),s=c("el-select"),u=c("el-form-item"),p=c("el-input"),d=c("el-radio-button"),C=c("el-radio-group"),F=c("el-button"),re=c("el-upload"),M=c("el-input-number"),se=c("el-date-picker"),me=c("el-form");return m(),i("section",ke,[B("h2",null,P(D.value?"编辑作品":"新增作品"),1),n(me,{model:a,"label-position":"top",size:"small",class:"form-grid compact-form"},{default:r(()=>[n(u,{label:"媒体类型*"},{default:r(()=>[n(s,{modelValue:a.mediaType,"onUpdate:modelValue":e[0]||(e[0]=t=>a.mediaType=t),placeholder:"请选择媒体类型",clearable:""},{default:r(()=>[(m(),i(b,null,v($,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(u,{label:"内容类型*"},{default:r(()=>[n(s,{modelValue:a.contentType,"onUpdate:modelValue":e[1]||(e[1]=t=>a.contentType=t),placeholder:"请选择内容类型",clearable:""},{default:r(()=>[(m(),i(b,null,v(H,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(u,{label:"原作*"},{default:r(()=>[n(p,{modelValue:a.fandom,"onUpdate:modelValue":e[2]||(e[2]=t=>a.fandom=t)},null,8,["modelValue"])]),_:1}),n(u,{label:"CP*"},{default:r(()=>[n(p,{modelValue:a.cp,"onUpdate:modelValue":e[3]||(e[3]=t=>a.cp=t)},null,8,["modelValue"])]),_:1}),n(u,{label:"标题"},{default:r(()=>[n(p,{modelValue:a.title,"onUpdate:modelValue":e[4]||(e[4]=t=>a.title=t)},null,8,["modelValue"])]),_:1}),n(u,{label:"作者"},{default:r(()=>[n(p,{modelValue:a.author,"onUpdate:modelValue":e[5]||(e[5]=t=>a.author=t)},null,8,["modelValue"])]),_:1}),n(u,{label:"来源链接",class:"span-2"},{default:r(()=>[n(p,{modelValue:a.sourceUrl,"onUpdate:modelValue":e[6]||(e[6]=t=>a.sourceUrl=t)},null,8,["modelValue"])]),_:1}),n(u,{label:"内容",class:"span-2"},{default:r(()=>[B("div",we,[n(C,{modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=t=>k.value=t),size:"small"},{default:r(()=>[n(d,{label:"text"},{default:r(()=>[...e[27]||(e[27]=[_("直接输入",-1)])]),_:1}),n(d,{label:"file"},{default:r(()=>[...e[28]||(e[28]=[_("上传本地文件",-1)])]),_:1})]),_:1},8,["modelValue"]),k.value==="text"?(m(),f(p,{key:0,modelValue:a.content,"onUpdate:modelValue":e[8]||(e[8]=t=>a.content=t),type:"textarea",rows:"5",placeholder:"可直接粘贴/输入内容"},null,8,["modelValue"])):(m(),i("div",Fe,[n(re,{"auto-upload":!1,"show-file-list":!1,"on-change":Z,limit:1,accept:".txt,.md,.json,.csv,.html,.htm,.xml,.yml,.yaml,image/*,video/*"},{default:r(()=>[n(F,null,{default:r(()=>[...e[29]||(e[29]=[_("选择本地文件",-1)])]),_:1})]),_:1}),B("span",Ue,P(w.value||"未选择文件"),1),n(F,{text:"",onClick:ee},{default:r(()=>[...e[30]||(e[30]=[_("清空",-1)])]),_:1})]))])]),_:1}),n(u,{label:"年份"},{default:r(()=>[n(M,{modelValue:a.releaseYear,"onUpdate:modelValue":e[9]||(e[9]=t=>a.releaseYear=t),placeholder:"可滑动选取",min:2019,max:2030,onWheel:e[10]||(e[10]=N(t=>I("releaseYear",t,1,2019,2030),["prevent"]))},null,8,["modelValue"])]),_:1}),n(u,{label:"追踪状态"},{default:r(()=>[n(s,{modelValue:a.trackingType,"onUpdate:modelValue":e[11]||(e[11]=t=>a.trackingType=t),placeholder:"请选择追踪状态",clearable:""},{default:r(()=>[(m(),i(b,null,v(q,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(u,{label:"评分(0-10)"},{default:r(()=>[n(M,{modelValue:a.rating,"onUpdate:modelValue":e[12]||(e[12]=t=>a.rating=t),placeholder:"可滑动选取",step:.5,min:0,max:10,onWheel:e[13]||(e[13]=N(t=>I("rating",t,.5,0,10),["prevent"]))},null,8,["modelValue"])]),_:1}),n(u,{label:"标签"},{default:r(()=>[n(s,{modelValue:a.tags,"onUpdate:modelValue":e[14]||(e[14]=t=>a.tags=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(m(!0),i(b,null,v(E.value,t=>(m(),f(o,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(u,{label:"平台"},{default:r(()=>[n(s,{modelValue:a.plts,"onUpdate:modelValue":e[15]||(e[15]=t=>a.plts=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(m(!0),i(b,null,v(A.value,t=>(m(),f(o,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(u,{label:"备注",class:"span-2"},{default:r(()=>[n(p,{modelValue:a.notes,"onUpdate:modelValue":e[16]||(e[16]=t=>a.notes=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),n(u,{label:"总结",class:"span-2"},{default:r(()=>[n(p,{modelValue:a.summary,"onUpdate:modelValue":e[17]||(e[17]=t=>a.summary=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),g.value?(m(),f(u,{key:0,label:"年代"},{default:r(()=>[n(s,{modelValue:a.fanficForm.era,"onUpdate:modelValue":e[18]||(e[18]=t=>a.fanficForm.era=t),placeholder:"请选择年代",clearable:""},{default:r(()=>[(m(),i(b,null,v(G,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:1,label:"篇幅"},{default:r(()=>[n(s,{modelValue:a.fanficForm.lengthType,"onUpdate:modelValue":e[19]||(e[19]=t=>a.fanficForm.lengthType=t),placeholder:"请选择篇幅",clearable:""},{default:r(()=>[(m(),i(b,null,v(J,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:2,label:"作品状态"},{default:r(()=>[n(s,{modelValue:a.fanficForm.workType,"onUpdate:modelValue":e[20]||(e[20]=t=>a.fanficForm.workType=t),placeholder:"请选择作品状态",clearable:""},{default:r(()=>[(m(),i(b,null,v(K,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:3,label:"结局"},{default:r(()=>[n(s,{modelValue:a.fanficForm.endingType,"onUpdate:modelValue":e[21]||(e[21]=t=>a.fanficForm.endingType=t),placeholder:"请选择结局",clearable:""},{default:r(()=>[(m(),i(b,null,v(z,t=>n(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:4,label:"设定",class:"fanfic-setting"},{default:r(()=>[n(p,{modelValue:a.fanficForm.charSetting,"onUpdate:modelValue":e[22]||(e[22]=t=>a.fanficForm.charSetting=t)},null,8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:5,label:"上次更新日期"},{default:r(()=>[n(se,{modelValue:a.fanficForm.updateDate,"onUpdate:modelValue":e[23]||(e[23]=t=>a.fanficForm.updateDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"请选择日期",clearable:""},null,8,["modelValue"])]),_:1})):V("",!0),g.value?(m(),f(u,{key:6,label:"阅读次数"},{default:r(()=>[n(M,{modelValue:a.fanficForm.readCount,"onUpdate:modelValue":e[24]||(e[24]=t=>a.fanficForm.readCount=t),placeholder:"可滑动选取",min:0,onWheel:e[25]||(e[25]=N(t=>te("readCount",t,1,0),["prevent"]))},null,8,["modelValue"])]),_:1})):V("",!0),n(u,{class:"span-2"},{default:r(()=>[n(F,{type:"primary",onClick:ue},{default:r(()=>[...e[31]||(e[31]=[_("保存",-1)])]),_:1}),n(F,{onClick:e[26]||(e[26]=t=>l.$router.back())},{default:r(()=>[...e[32]||(e[32]=[_("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])}}},Ne=pe(Se,[["__scopeId","data-v-a830583e"]]);export{Ne as default};

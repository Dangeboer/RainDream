import{_ as K,r as V,o as s,c as k,a as u,w as r,F as U,l as O,e as g,b as q,g as D,t as Q,d as R,f as M,s as $,E as Y,h as L,i as X,p as Z,k as c,j as _,u as ee}from"./index-C-cxag21.js";import{u as le,c as te,b as ne}from"./item-i1R5OOup.js";import{g as ae,a as oe,c as ue,b as re}from"./meta-THe6UZ6F.js";import"./http-DDYn0A1M.js";const se={class:"content-input"},ie={key:1,class:"content-upload"},me={class:"file-name"},de={__name:"ItemFormFields",props:{form:{type:Object,required:!0},tags:{type:Array,default:()=>[]},plts:{type:Array,default:()=>[]},isFanficType:{type:Boolean,default:!1},contentInputMode:{type:String,default:"text"},contentFileName:{type:String,default:""},contentTypeOptions:{type:Array,default:()=>[]},mediaTypeOptions:{type:Array,default:()=>[]},trackingTypeOptions:{type:Array,default:()=>[]},endingTypeOptions:{type:Array,default:()=>[]},eraOptions:{type:Array,default:()=>[]},lengthTypeOptions:{type:Array,default:()=>[]},workTypeOptions:{type:Array,default:()=>[]},onContentFileChange:{type:Function,required:!0},clearContentFile:{type:Function,required:!0},onWheelField:{type:Function,required:!0},onWheelFanficField:{type:Function,required:!0}},emits:["update:contentInputMode"],setup(l,{emit:p}){const y=l,f=p,i=$({get:()=>y.contentInputMode,set:b=>f("update:contentInputMode",b)});return(b,a)=>{const n=V("el-option"),v=V("el-select"),m=V("el-form-item"),F=V("el-input"),E=V("el-radio-button"),N=V("el-radio-group"),h=V("el-button"),I=V("el-upload"),S=V("el-input-number"),W=V("el-date-picker");return s(),k(U,null,[u(m,{label:"媒体类型*"},{default:r(()=>[u(v,{modelValue:l.form.mediaType,"onUpdate:modelValue":a[0]||(a[0]=t=>l.form.mediaType=t),placeholder:"请选择媒体类型",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.mediaTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(m,{label:"内容类型*"},{default:r(()=>[u(v,{modelValue:l.form.contentType,"onUpdate:modelValue":a[1]||(a[1]=t=>l.form.contentType=t),placeholder:"请选择内容类型",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.contentTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(m,{label:"原作*"},{default:r(()=>[u(F,{modelValue:l.form.fandom,"onUpdate:modelValue":a[2]||(a[2]=t=>l.form.fandom=t)},null,8,["modelValue"])]),_:1}),u(m,{label:"CP*"},{default:r(()=>[u(F,{modelValue:l.form.cp,"onUpdate:modelValue":a[3]||(a[3]=t=>l.form.cp=t)},null,8,["modelValue"])]),_:1}),u(m,{label:"标题"},{default:r(()=>[u(F,{modelValue:l.form.title,"onUpdate:modelValue":a[4]||(a[4]=t=>l.form.title=t)},null,8,["modelValue"])]),_:1}),u(m,{label:"作者"},{default:r(()=>[u(F,{modelValue:l.form.author,"onUpdate:modelValue":a[5]||(a[5]=t=>l.form.author=t)},null,8,["modelValue"])]),_:1}),u(m,{label:"来源链接",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.sourceUrl,"onUpdate:modelValue":a[6]||(a[6]=t=>l.form.sourceUrl=t)},null,8,["modelValue"])]),_:1}),u(m,{label:"内容",class:"span-2"},{default:r(()=>[q("div",se,[u(N,{modelValue:i.value,"onUpdate:modelValue":a[7]||(a[7]=t=>i.value=t),size:"small"},{default:r(()=>[u(E,{label:"text"},{default:r(()=>[...a[26]||(a[26]=[D("直接输入",-1)])]),_:1}),u(E,{label:"file"},{default:r(()=>[...a[27]||(a[27]=[D("上传本地文件",-1)])]),_:1})]),_:1},8,["modelValue"]),i.value==="text"?(s(),g(F,{key:0,modelValue:l.form.content,"onUpdate:modelValue":a[8]||(a[8]=t=>l.form.content=t),type:"textarea",rows:"5",placeholder:"可直接粘贴/输入内容"},null,8,["modelValue"])):(s(),k("div",ie,[u(I,{"auto-upload":!1,"show-file-list":!1,"on-change":l.onContentFileChange,limit:1,accept:".txt,.md,.json,.csv,.html,.htm,.xml,.yml,.yaml,image/*,video/*"},{default:r(()=>[u(h,null,{default:r(()=>[...a[28]||(a[28]=[D("选择本地文件",-1)])]),_:1})]),_:1},8,["on-change"]),q("span",me,Q(l.contentFileName||"未选择文件"),1),u(h,{text:"",onClick:l.clearContentFile},{default:r(()=>[...a[29]||(a[29]=[D("清空",-1)])]),_:1},8,["onClick"])]))])]),_:1}),u(m,{label:"年份"},{default:r(()=>[u(S,{modelValue:l.form.releaseYear,"onUpdate:modelValue":a[9]||(a[9]=t=>l.form.releaseYear=t),placeholder:"可滑动选取",min:2019,max:2030,onWheel:a[10]||(a[10]=R(t=>l.onWheelField("releaseYear",t,1,2019,2030),["prevent"]))},null,8,["modelValue"])]),_:1}),u(m,{label:"追踪状态"},{default:r(()=>[u(v,{modelValue:l.form.trackingType,"onUpdate:modelValue":a[11]||(a[11]=t=>l.form.trackingType=t),placeholder:"请选择追踪状态",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.trackingTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(m,{label:"评分(0-10)"},{default:r(()=>[u(S,{modelValue:l.form.rating,"onUpdate:modelValue":a[12]||(a[12]=t=>l.form.rating=t),placeholder:"可滑动选取",step:.5,min:0,max:10,onWheel:a[13]||(a[13]=R(t=>l.onWheelField("rating",t,.5,0,10),["prevent"]))},null,8,["modelValue"])]),_:1}),u(m,{label:"标签"},{default:r(()=>[u(v,{modelValue:l.form.tags,"onUpdate:modelValue":a[14]||(a[14]=t=>l.form.tags=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(s(!0),k(U,null,O(l.tags,t=>(s(),g(n,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(m,{label:"平台"},{default:r(()=>[u(v,{modelValue:l.form.plts,"onUpdate:modelValue":a[15]||(a[15]=t=>l.form.plts=t),multiple:"",filterable:"","allow-create":"","default-first-option":""},{default:r(()=>[(s(!0),k(U,null,O(l.plts,t=>(s(),g(n,{key:t.id,label:t.name,value:t.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(m,{label:"备注",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.notes,"onUpdate:modelValue":a[16]||(a[16]=t=>l.form.notes=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),u(m,{label:"总结",class:"span-2"},{default:r(()=>[u(F,{modelValue:l.form.summary,"onUpdate:modelValue":a[17]||(a[17]=t=>l.form.summary=t),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),l.isFanficType?(s(),g(m,{key:0,label:"年代"},{default:r(()=>[u(v,{modelValue:l.form.fanficForm.era,"onUpdate:modelValue":a[18]||(a[18]=t=>l.form.fanficForm.era=t),placeholder:"请选择年代",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.eraOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:1,label:"篇幅"},{default:r(()=>[u(v,{modelValue:l.form.fanficForm.lengthType,"onUpdate:modelValue":a[19]||(a[19]=t=>l.form.fanficForm.lengthType=t),placeholder:"请选择篇幅",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.lengthTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:2,label:"作品状态"},{default:r(()=>[u(v,{modelValue:l.form.fanficForm.workType,"onUpdate:modelValue":a[20]||(a[20]=t=>l.form.fanficForm.workType=t),placeholder:"请选择作品状态",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.workTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:3,label:"结局"},{default:r(()=>[u(v,{modelValue:l.form.fanficForm.endingType,"onUpdate:modelValue":a[21]||(a[21]=t=>l.form.fanficForm.endingType=t),placeholder:"请选择结局",clearable:""},{default:r(()=>[(s(!0),k(U,null,O(l.endingTypeOptions,t=>(s(),g(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:4,label:"设定",class:"fanfic-setting"},{default:r(()=>[u(F,{modelValue:l.form.fanficForm.charSetting,"onUpdate:modelValue":a[22]||(a[22]=t=>l.form.fanficForm.charSetting=t)},null,8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:5,label:"上次更新日期"},{default:r(()=>[u(W,{modelValue:l.form.fanficForm.updateDate,"onUpdate:modelValue":a[23]||(a[23]=t=>l.form.fanficForm.updateDate=t),type:"date","value-format":"YYYY-MM-DD",placeholder:"请选择日期",clearable:""},null,8,["modelValue"])]),_:1})):M("",!0),l.isFanficType?(s(),g(m,{key:6,label:"阅读次数"},{default:r(()=>[u(S,{modelValue:l.form.fanficForm.readCount,"onUpdate:modelValue":a[24]||(a[24]=t=>l.form.fanficForm.readCount=t),placeholder:"可滑动选取",min:0,onWheel:a[25]||(a[25]=R(t=>l.onWheelFanficField("readCount",t,1,0),["prevent"]))},null,8,["modelValue"])]),_:1})):M("",!0)],64)}}},fe=K(de,[["__scopeId","data-v-470cefbe"]]),pe=[{value:1,label:"文章"},{value:2,label:"图绘"},{value:3,label:"精修"},{value:4,label:"混剪"},{value:5,label:"解析"},{value:6,label:"吐槽"},{value:7,label:"主创说"},{value:8,label:"RPS"},{value:9,label:"其他"}],ce=[{value:1,label:"文本"},{value:2,label:"静图"},{value:3,label:"动图"},{value:4,label:"实况照片"},{value:5,label:"视频"},{value:6,label:"链接"}],ye=[{value:1,label:"未看"},{value:2,label:"在看"},{value:3,label:"追平"},{value:4,label:"看过"},{value:5,label:"归档"}],be=[{value:1,label:"HE"},{value:2,label:"BE"},{value:3,label:"OE"},{value:4,label:"ME"}],ge=[{value:1,label:"古代"},{value:2,label:"民国"},{value:3,label:"现代"}],ve=[{value:1,label:"短篇"},{value:2,label:"中篇"},{value:3,label:"长篇"}],Te=[{value:1,label:"已完结"},{value:2,label:"更新中"},{value:3,label:"断更"},{value:4,label:"已弃"}],Fe=()=>({era:null,charSetting:"",lengthType:null,workType:null,updateDate:null,endingType:null,readCount:1}),Ve=(l,p)=>new Promise((y,f)=>{const i=new FileReader;i.onload=()=>y(i.result||""),i.onerror=f,p?i.readAsText(l):i.readAsDataURL(l)}),ke=l=>{var y;const p=/\.(txt|md|json|csv|html?|xml|ya?ml|js|ts|vue|java|kt|py|go|rs|sql|sh)$/i;return((y=l.type)==null?void 0:y.startsWith("text/"))||p.test(l.name||"")},we=(l,p,y)=>{let f=l;return typeof p=="number"&&(f=Math.max(p,f)),typeof y=="number"&&(f=Math.min(y,f)),f},B=80,Ue=180,G=(l,p,y)=>{const f=Date.now(),i=l.get(p)||{acc:0,lastAt:0};f-i.lastAt>Ue&&(i.acc=0),i.lastAt=f,i.acc+=-y.deltaY;let b=0;return i.acc>=B?b=Math.floor(i.acc/B):i.acc<=-B&&(b=Math.ceil(i.acc/B)),b!==0&&(i.acc-=b*B),l.set(p,i),b},J=(l,p,y,f,i)=>{if(p===0)return l;const b=typeof l=="number"?l:typeof f=="number"?f:0,a=p*y,n=Number((b+a).toFixed(6));return we(n,f,i)},x=l=>{if(l==null)return null;const p=String(l).trim();return p===""?null:p},xe=({route:l,router:p})=>{const y=L([]),f=L([]),i=L("text"),b=L(""),a=new Map,n=X({mediaType:null,contentType:null,storeUrl:"",content:null,title:"",fandom:"风声",cp:"玉梦",author:"",sourceUrl:"",releaseYear:null,trackingType:null,rating:null,notes:"",summary:"",fanficForm:Fe(),tags:[],plts:[]}),v=$(()=>!!l.params.id),m=$(()=>Number(n.contentType)===1),F=async e=>{const o=e==null?void 0:e.raw;if(!o)return;const d=ke(o);n.content=await Ve(o,d),b.value=o.name||"",d||Y.info("已读取为 Base64 Data URL")},E=()=>{b.value="",n.content=null},N=async()=>{if(!v.value)return;const e=await ne(l.params.id),o=(e==null?void 0:e.fanficForm)||(e==null?void 0:e.fanfic_form)||{};n.mediaType=(e==null?void 0:e.mediaType)??(e==null?void 0:e.media_type)??null,n.contentType=(e==null?void 0:e.contentType)??(e==null?void 0:e.content_type)??null,n.storeUrl=(e==null?void 0:e.storeUrl)??(e==null?void 0:e.store_url)??"",n.content=(e==null?void 0:e.content)??n.storeUrl??null,n.title=(e==null?void 0:e.title)??"",n.fandom=(e==null?void 0:e.fandom)??"风声",n.cp=(e==null?void 0:e.cp)??"玉梦",n.author=(e==null?void 0:e.author)??"",n.sourceUrl=(e==null?void 0:e.sourceUrl)??(e==null?void 0:e.source_url)??"",n.releaseYear=(e==null?void 0:e.releaseYear)??(e==null?void 0:e.release_year)??null,n.trackingType=(e==null?void 0:e.trackingType)??(e==null?void 0:e.tracking_type)??null,n.rating=(e==null?void 0:e.rating)??null,n.notes=(e==null?void 0:e.notes)??"",n.summary=(e==null?void 0:e.summary)??"",n.fanficForm={era:(o==null?void 0:o.era)??null,charSetting:(o==null?void 0:o.charSetting)??(o==null?void 0:o.char_setting)??"",lengthType:(o==null?void 0:o.lengthType)??(o==null?void 0:o.length_type)??null,workType:(o==null?void 0:o.workType)??(o==null?void 0:o.work_type)??null,updateDate:(o==null?void 0:o.updateDate)??(o==null?void 0:o.update_date)??null,endingType:(o==null?void 0:o.endingType)??(o==null?void 0:o.ending_type)??null,readCount:(o==null?void 0:o.readCount)??(o==null?void 0:o.read_count)??1},n.tags=((e==null?void 0:e.tags)||(e==null?void 0:e.tag_vos)||[]).map(d=>(d==null?void 0:d.name)||(d==null?void 0:d.tag_name)||d).filter(Boolean),n.plts=((e==null?void 0:e.plts)||(e==null?void 0:e.plt_vos)||[]).map(d=>(d==null?void 0:d.name)||(d==null?void 0:d.plt_name)||d).filter(Boolean),i.value=typeof n.content=="string"&&n.content.startsWith("data:")?"file":"text",b.value=""},h=async()=>{const[e,o]=await Promise.all([ae(),oe()]);y.value=Array.isArray(e)?e:[],f.value=Array.isArray(o)?o:[]},I=async(e,o,d)=>{const T=[...new Set((e||[]).map(w=>String(w||"").trim()).filter(Boolean))],C=new Set((o.value||[]).map(w=>w==null?void 0:w.name).filter(Boolean)),A=T.filter(w=>!C.has(w));A.length!==0&&await Promise.all(A.map(w=>d({name:w})))},S=(e,o,d=1,T,C)=>{const A=G(a,`form:${e}`,o);n[e]=J(n[e],A,d,T,C)},W=(e,o,d=1,T,C)=>{const A=G(a,`fanfic:${e}`,o);n.fanficForm[e]=J(n.fanficForm[e],A,d,T,C)},t=()=>({media_type:n.mediaType,content_type:n.contentType,store_url:[2,3,4,5].includes(Number(n.mediaType))?x(n.content):null,content:Number(n.mediaType)===1?x(n.content):null,title:x(n.title),fandom:x(n.fandom)??"风声",cp:x(n.cp)??"玉梦",author:x(n.author),source_url:x(n.sourceUrl),release_year:n.releaseYear,tracking_type:n.trackingType,rating:n.rating,notes:x(n.notes),summary:x(n.summary),fanfic_form:m.value?{era:n.fanficForm.era,char_setting:x(n.fanficForm.charSetting),length_type:n.fanficForm.lengthType,work_type:n.fanficForm.workType,update_date:n.fanficForm.updateDate,ending_type:n.fanficForm.endingType,read_count:n.fanficForm.readCount??1}:null,media_form:Number(n.mediaType)===4?{live_url:null}:null,tags:[...new Set((n.tags||[]).map(e=>String(e||"").trim()).filter(Boolean))],plts:[...new Set((n.plts||[]).map(e=>String(e||"").trim()).filter(Boolean))]}),P=()=>{const e=Number(n.contentType);return e===1?{path:"/fanfic"}:e>1?{path:"/items",query:{contentType:e}}:{path:"/items"}};return{form:n,isEdit:v,isFanficType:m,tags:y,plts:f,contentInputMode:i,contentFileName:b,contentTypeOptions:pe,mediaTypeOptions:ce,trackingTypeOptions:ye,endingTypeOptions:be,eraOptions:ge,lengthTypeOptions:ve,workTypeOptions:Te,onContentFileChange:F,clearContentFile:E,onWheelField:S,onWheelFanficField:W,submit:async()=>{if(!n.mediaType||!n.contentType||!n.fandom||!n.cp)return Y.warning("请先填写必填项");await I(n.tags,y,ue),await I(n.plts,f,re),await h();const e=t();v.value?(await le(l.params.id,e),Y.success("更新成功")):(await te(e),Y.success("创建成功")),p.push(P())},init:async()=>{await h(),await N()}}},Oe={class:"card-panel panel"},Ce={__name:"ItemFormView",setup(l){const p=_(),y=ee(),{form:f,isEdit:i,isFanficType:b,tags:a,plts:n,contentInputMode:v,contentFileName:m,contentTypeOptions:F,mediaTypeOptions:E,trackingTypeOptions:N,endingTypeOptions:h,eraOptions:I,lengthTypeOptions:S,workTypeOptions:W,onContentFileChange:t,clearContentFile:P,onWheelField:j,onWheelFanficField:H,submit:e,init:o}=xe({route:p,router:y});return Z(o),(d,T)=>{const C=V("el-button"),A=V("el-form-item"),w=V("el-form");return s(),k("section",Oe,[q("h2",null,Q(c(i)?"编辑作品":"新增作品"),1),u(w,{model:c(f),"label-position":"top",size:"small",class:"form-grid compact-form"},{default:r(()=>[u(fe,{form:c(f),tags:c(a),plts:c(n),"is-fanfic-type":c(b),"content-input-mode":c(v),"content-file-name":c(m),"content-type-options":c(F),"media-type-options":c(E),"tracking-type-options":c(N),"ending-type-options":c(h),"era-options":c(I),"length-type-options":c(S),"work-type-options":c(W),"on-content-file-change":c(t),"clear-content-file":c(P),"on-wheel-field":c(j),"on-wheel-fanfic-field":c(H),"onUpdate:contentInputMode":T[0]||(T[0]=z=>v.value=z)},null,8,["form","tags","plts","is-fanfic-type","content-input-mode","content-file-name","content-type-options","media-type-options","tracking-type-options","ending-type-options","era-options","length-type-options","work-type-options","on-content-file-change","clear-content-file","on-wheel-field","on-wheel-fanfic-field"]),u(A,{class:"span-2"},{default:r(()=>[u(C,{type:"primary",onClick:c(e)},{default:r(()=>[...T[2]||(T[2]=[D("保存",-1)])]),_:1},8,["onClick"]),u(C,{onClick:T[1]||(T[1]=z=>d.$router.back())},{default:r(()=>[...T[3]||(T[3]=[D("取消",-1)])]),_:1})]),_:1})]),_:1},8,["model"])])}}},Ee=K(Ce,[["__scopeId","data-v-87f57a13"]]);export{Ee as default};
